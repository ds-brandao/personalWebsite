name: Deploy Website

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: self-hosted

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        ref: ${{ github.event.pull_request.head.sha }}
        fetch-depth: 0

    - name: Verify project structure
      run: |
        echo "Checking React app structure..."
        ls -la
        ls -la ./react-app
        ls -la ./react-app/public/config

    - name: Stop existing containers
      run: |
        # Stop docker-compose services (legacy)
        docker compose down || true
        
        # Force stop and remove the personal-website container
        docker rm -f personal-website || true
        
        # Find and stop any container using port 80
        CONTAINER_ON_80=$(docker ps -q --filter "publish=80" || true)
        if [ -n "$CONTAINER_ON_80" ]; then
          echo "Found container(s) using port 80: $CONTAINER_ON_80"
          docker rm -f $CONTAINER_ON_80 || true
        fi
        
        # Wait for port to be released
        sleep 3
        
        # Verify port 80 is free
        if lsof -i :80 > /dev/null 2>&1; then
          echo "Warning: Port 80 still in use by non-Docker process"
          lsof -i :80 || true
        fi

    - name: Build React app Docker image
      run: |
        echo "Building React app with multi-stage Docker build..."
        docker build -t personal-website .

    - name: Run production container
      run: |
        echo "Starting production container..."
        docker run -d --name personal-website -p 80:80 personal-website

        # Wait for container to be ready
        echo "Waiting for container to start..."
        sleep 10

    - name: Test website
      run: |
        echo "Testing if website is accessible..."

        # Test main page
        HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:80/)
        if [ "$HTTP_CODE" = "200" ]; then
          echo "Main page is accessible (HTTP $HTTP_CODE)"
        else
          echo "Main page returned HTTP $HTTP_CODE"
          docker logs personal-website
          exit 1
        fi

        # Test config.json
        HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:80/config/config.json)
        if [ "$HTTP_CODE" = "200" ]; then
          echo "Config file is accessible (HTTP $HTTP_CODE)"
        else
          echo "Config file returned HTTP $HTTP_CODE"
          docker logs personal-website
          exit 1
        fi

        # Test articles.json
        HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:80/config/articles.json)
        if [ "$HTTP_CODE" = "200" ]; then
          echo "Articles file is accessible (HTTP $HTTP_CODE)"
        else
          echo "Articles file returned HTTP $HTTP_CODE"
          docker logs personal-website
          exit 1
        fi

        echo "Website deployment successful!"

    - name: Show container logs
      if: failure()
      run: docker logs personal-website || true

    - name: Clean up on failure
      if: failure()
      run: |
        docker stop personal-website || true
        docker rm personal-website || true

    - name: Clean up old images
      if: always()
      run: |
        # Remove any unused images and volumes
        docker system prune -f
