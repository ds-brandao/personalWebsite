name: Deploy Website

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: self-hosted

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        ref: ${{ github.event.pull_request.head.sha }}
        fetch-depth: 0

    - name: Verify project structure
      run: |
        echo "Checking React app structure..."
        ls -la
        ls -la ./react-app
        ls -la ./react-app/public/config

    - name: Stop existing containers
      run: |
        # Stop docker-compose services (legacy)
        docker compose down || true
        # Stop and remove standalone container if it exists
        docker stop personal-website || true
        docker rm personal-website || true

    - name: Build React app Docker image
      run: |
        echo "Building React app with multi-stage Docker build..."
        docker build -t personal-website .

    - name: Run production container
      run: |
        echo "Starting production container..."
        docker run -d --name personal-website -p 80:80 personal-website

        # Wait for container to be ready
        echo "Waiting for container to start..."
        sleep 10

    - name: Test website
      run: |
        echo "Testing if website is accessible..."

        # Test main page
        HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:80/)
        if [ "$HTTP_CODE" = "200" ]; then
          echo "Main page is accessible (HTTP $HTTP_CODE)"
        else
          echo "Main page returned HTTP $HTTP_CODE"
          docker logs personal-website
          exit 1
        fi

        # Test config.json
        HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:80/config/config.json)
        if [ "$HTTP_CODE" = "200" ]; then
          echo "Config file is accessible (HTTP $HTTP_CODE)"
        else
          echo "Config file returned HTTP $HTTP_CODE"
          docker logs personal-website
          exit 1
        fi

        # Test articles.json
        HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:80/config/articles.json)
        if [ "$HTTP_CODE" = "200" ]; then
          echo "Articles file is accessible (HTTP $HTTP_CODE)"
        else
          echo "Articles file returned HTTP $HTTP_CODE"
          docker logs personal-website
          exit 1
        fi

        echo "Website deployment successful!"

    - name: Show container logs
      if: failure()
      run: docker logs personal-website || true

    - name: Clean up on failure
      if: failure()
      run: |
        docker stop personal-website || true
        docker rm personal-website || true

    - name: Clean up old images
      if: always()
      run: |
        # Remove any unused images and volumes
        docker system prune -f
